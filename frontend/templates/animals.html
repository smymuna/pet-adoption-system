{% extends "base.html" %}

{% block title %}Animals - Pet Adoption System{% endblock %}
{% block page_title %}Animals Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
    <h3>Animals List</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAnimalModal">
        <i class="bi bi-plus-circle"></i> Add Animal
    </button>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Name</th>
            <th>Species</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="animalsTableBody">
        {% for animal in animals %}
        <tr data-id="{{ animal._id }}">
            <td>{{ animal.name }}</td>
            <td>{{ animal.species }}</td>
            <td>{{ animal.age }}</td>
            <td>{{ animal.gender }}</td>
            <td><span class="badge bg-{{ 'success' if animal.status == 'Available' else 'primary' if animal.status == 'Adopted' else 'warning' }}">{{ animal.status }}</span></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editAnimal('{{ animal._id }}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteAnimal('{{ animal._id }}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Add Animal Modal -->
<div class="modal fade" id="addAnimalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Animal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAnimalForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Species</label>
                        <input type="text" class="form-control" name="species" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" name="age" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gender</label>
                        <select class="form-select" name="gender" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" required>
                            <option value="Available">Available</option>
                            <option value="Adopted">Adopted</option>
                            <option value="Medical">Medical</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAnimal()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Animal Modal -->
<div class="modal fade" id="editAnimalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Animal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAnimalForm">
                    <input type="hidden" name="id" id="editAnimalId">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" id="editAnimalName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Species</label>
                        <input type="text" class="form-control" name="species" id="editAnimalSpecies" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" name="age" id="editAnimalAge" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gender</label>
                        <select class="form-select" name="gender" id="editAnimalGender" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="editAnimalStatus" required>
                            <option value="Available">Available</option>
                            <option value="Adopted">Adopted</option>
                            <option value="Medical">Medical</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAnimal()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function saveAnimal() {
    const form = document.getElementById('addAnimalForm');
    const formData = Object.fromEntries(new FormData(form));
    
    const response = await fetch('/api/animals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    });
    
    if (response.ok) {
        location.reload();
    } else {
        showAlert('Error adding animal', 'danger');
    }
}

async function editAnimal(id) {
    const response = await fetch(`/api/animals/${id}`);
    const animal = await response.json();
    
    document.getElementById('editAnimalId').value = animal._id;
    document.getElementById('editAnimalName').value = animal.name;
    document.getElementById('editAnimalSpecies').value = animal.species;
    document.getElementById('editAnimalAge').value = animal.age;
    document.getElementById('editAnimalGender').value = animal.gender;
    document.getElementById('editAnimalStatus').value = animal.status;
    
    new bootstrap.Modal(document.getElementById('editAnimalModal')).show();
}

async function updateAnimal() {
    const form = document.getElementById('editAnimalForm');
    const id = document.getElementById('editAnimalId').value;
    const formData = Object.fromEntries(new FormData(form));
    delete formData.id;
    
    const response = await fetch(`/api/animals/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    });
    
    if (response.ok) {
        location.reload();
    } else {
        showAlert('Error updating animal', 'danger');
    }
}

async function deleteAnimal(id) {
    if (!confirm('Are you sure you want to delete this animal?')) return;
    
    const response = await fetch(`/api/animals/${id}`, {
        method: 'DELETE'
    });
    
    if (response.ok) {
        location.reload();
    } else {
        showAlert('Error deleting animal', 'danger');
    }
}
</script>
{% endblock %}

