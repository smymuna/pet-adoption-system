{% extends "base.html" %}

{% block title %}ML Predictions - Pet Adoption System{% endblock %}
{% block page_title %}Machine Learning Predictions{% endblock %}

{% block content %}
<!-- Explanation Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> Priority Scoring System</h5>
                <p class="mb-2">This system uses a <strong>simple rule-based scoring system</strong> to calculate priority scores for animals:</p>
                <ul class="mb-2">
                    <li><strong>Priority Score:</strong> A simple score (0-100%) that indicates how urgently an animal needs attention/marketing. Calculated from 5 factors: age, days in shelter, medical history, species popularity, and status. No ML training required - works immediately!</li>
                    <li><strong>Time-to-Adoption Prediction:</strong> Uses a Random Forest Regressor to predict how many days it will take for an animal to be adopted (requires training with adoption data).</li>
                </ul>
                <p class="mb-0"><strong>Scoring Factors (Total: 100 points):</strong></p>
                <ul class="mb-0">
                    <li><strong>Age (0-30 points):</strong> Younger animals score higher</li>
                    <li><strong>Days in Shelter (0-25 points):</strong> Fewer days = higher score</li>
                    <li><strong>Medical History (0-20 points):</strong> Fewer visits = higher score</li>
                    <li><strong>Species Popularity (0-15 points):</strong> Dogs and cats score highest</li>
                    <li><strong>Status (0-10 points):</strong> Available status gets full points</li>
                </ul>
                <p class="mt-2 mb-0"><small class="text-muted">The priority score helps identify which animals need immediate attention or marketing efforts. Higher scores indicate animals that should be prioritized for adoption promotion.</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Model Status & Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Model Status</h5>
            </div>
            <div class="card-body">
                <div id="modelStatus">
                    <p class="text-muted">Loading model status...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tools"></i> Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-2" onclick="trainModels()" style="width: 100%;">
            <i class="bi bi-gear"></i> Train Models
        </button>
                <button class="btn btn-success mb-2" onclick="loadPredictions()" style="width: 100%;">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Predictions
                </button>
                <small class="text-muted d-block">Priority Score works immediately (no training needed). Time-to-adoption prediction requires training with at least 5 adoptions.</small>
            </div>
        </div>
    </div>
</div>

<!-- Predictions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Adoption Predictions for Available Animals</h5>
                <div>
                    <label class="form-label me-2">Sort by:</label>
                    <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="sortSelect" onchange="sortPredictions()">
                        <option value="score-desc">Priority Score (High to Low)</option>
                        <option value="score-asc">Priority Score (Low to High)</option>
                        <option value="time-asc">Time to Adoption (Shortest First)</option>
                        <option value="time-desc">Time to Adoption (Longest First)</option>
                        <option value="name">Name (A-Z)</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="predictionsContainer">
                    <p class="text-muted">Click "Refresh Predictions" to load predictions</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feature Importance Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Priority Score Factors</h5>
            </div>
            <div class="card-body">
                <div id="likelihoodImportance">
                    <p class="text-muted">Priority score is calculated from: Age (30%), Days in Shelter (25%), Medical History (20%), Species (15%), Status (10%)</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Feature Importance - Time to Adoption</h5>
            </div>
            <div class="card-body">
                <div id="timeImportance">
                    <p class="text-muted">Train models to see feature importance</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualization Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Priority Score Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="likelihoodChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Time to Adoption Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="timeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let predictionsData = [];
let likelihoodChart, timeChart;

// Load model status
async function loadModelStatus() {
    try {
        const response = await fetch('/api/ml/model-status');
        const status = await response.json();
        
        const container = document.getElementById('modelStatus');
        let html = '<div class="mb-2">';
        
        // Priority Score (always available - no training needed)
        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
        html += '<span><strong>Priority Score:</strong></span>';
        html += '<span class="badge bg-success">Always Available</span>';
        html += '</div>';
        html += '<small class="text-muted d-block mb-2">Simple rule-based calculation - no training required</small>';
        
        // Time to Adoption Model
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<span><strong>Time-to-Adoption Model:</strong></span>';
        if (status.time_to_adoption.trained) {
            html += '<span class="badge bg-success">Trained</span>';
        } else {
            html += '<span class="badge bg-warning">Not Trained</span>';
        }
        html += '</div>';
        
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        document.getElementById('modelStatus').innerHTML = '<p class="text-danger">Error loading model status</p>';
    }
}

// Train models
async function trainModels() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Training...';
    
    try {
        const response = await fetch('/api/ml/train', {
            method: 'POST'
        });
        const result = await response.json();
        
        if (response.ok) {
            let message = 'Model training completed!<br>';
            if (result.time_to_adoption?.trained) {
                message += `✓ Time-to-Adoption Model: R² = ${result.time_to_adoption.r2_score}<br>`;
            } else {
                message += `✗ Time-to-Adoption Model: ${result.time_to_adoption?.message || 'Failed'}<br>`;
            }
            message += '<small>Note: Priority Score works immediately without training</small>';
            showAlert(message, 'success');
            loadModelStatus();
            loadPredictions();
            loadFeatureImportance();
        } else {
            showAlert('Training failed: ' + (result.detail || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Error training models: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-gear"></i> Train Models';
    }
}

// Load predictions
async function loadPredictions() {
    const container = document.getElementById('predictionsContainer');
    container.innerHTML = '<p class="text-muted">Loading predictions...</p>';
    
    try {
        const response = await fetch('/api/ml/predictions');
        predictionsData = await response.json();
        
        if (predictionsData.length === 0) {
            container.innerHTML = '<p class="text-muted">No predictions available. Train models first or ensure there are available animals.</p>';
            return;
        }
        
        renderPredictionsTable(predictionsData);
        updateCharts(predictionsData);
    } catch (error) {
        container.innerHTML = '<p class="text-danger">Error loading predictions: ' + error.message + '</p>';
    }
}

// Render predictions table
function renderPredictionsTable(data) {
    const container = document.getElementById('predictionsContainer');
    
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    html += '<thead><tr>';
    html += '<th>Name</th><th>Species</th><th>Breed</th><th>Age</th><th>Gender</th>';
    html += '<th>Medical History</th><th>Behavioral Notes</th>';
    html += '<th>Priority Score</th><th>Time to Adoption</th><th>Priority</th>';
    html += '</tr></thead><tbody>';
    
    data.forEach(pred => {
        const score = pred.priority_score !== null && pred.priority_score !== undefined ? pred.priority_score + '%' : 'N/A';
        const time = pred.time_to_adoption_days !== null ? pred.time_to_adoption_days + ' days' : 'N/A';
        const medicalCount = pred.medical_count !== undefined ? pred.medical_count : 0;
        const behavioralNotes = pred.behavioral_notes && pred.behavioral_notes !== 'N/A' 
            ? (pred.behavioral_notes.length > 50 
                ? pred.behavioral_notes.substring(0, 50) + '...' 
                : pred.behavioral_notes)
            : 'N/A';
        
        // Priority badge color
        let priorityClass = 'bg-secondary';
        if (pred.priority === 'High') priorityClass = 'bg-danger';
        else if (pred.priority === 'Medium') priorityClass = 'bg-warning';
        else if (pred.priority === 'Low') priorityClass = 'bg-info';
        
        // Score progress bar color
        let scoreClass = 'bg-danger';
        if (pred.priority_score >= 70) scoreClass = 'bg-success';
        else if (pred.priority_score >= 40) scoreClass = 'bg-warning';
        
        html += `<tr>
            <td><strong>${pred.name}</strong></td>
            <td>${pred.species}</td>
            <td>${pred.breed || 'N/A'}</td>
            <td>${pred.age} years</td>
            <td>${pred.gender}</td>
            <td>
                <span class="badge ${medicalCount > 0 ? 'bg-warning' : 'bg-secondary'}">
                    ${medicalCount} ${medicalCount === 1 ? 'visit' : 'visits'}
                </span>
            </td>
            <td>
                <small title="${pred.behavioral_notes && pred.behavioral_notes !== 'N/A' ? pred.behavioral_notes : ''}">
                    ${behavioralNotes}
                </small>
            </td>
            <td>
                ${pred.priority_score !== null && pred.priority_score !== undefined ? `
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${scoreClass}" role="progressbar" 
                             style="width: ${pred.priority_score}%" 
                             aria-valuenow="${pred.priority_score}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${score}
                        </div>
                    </div>
                ` : 'N/A'}
            </td>
            <td>${time}</td>
            <td><span class="badge ${priorityClass}">${pred.priority}</span></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Sort predictions
function sortPredictions() {
    const sortValue = document.getElementById('sortSelect').value;
    let sorted = [...predictionsData];
    
    switch(sortValue) {
        case 'score-desc':
            sorted.sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0));
            break;
        case 'score-asc':
            sorted.sort((a, b) => (a.priority_score || 0) - (b.priority_score || 0));
            break;
        case 'time-asc':
            sorted.sort((a, b) => (a.time_to_adoption_days || Infinity) - (b.time_to_adoption_days || Infinity));
            break;
        case 'time-desc':
            sorted.sort((a, b) => (b.time_to_adoption_days || -Infinity) - (a.time_to_adoption_days || -Infinity));
            break;
        case 'name':
            sorted.sort((a, b) => a.name.localeCompare(b.name));
            break;
    }
    
    renderPredictionsTable(sorted);
}

// Update charts
function updateCharts(data) {
    // Priority score distribution
    const scoreRanges = {
        '0-20%': 0,
        '21-40%': 0,
        '41-60%': 0,
        '61-80%': 0,
        '81-100%': 0
    };
    
    data.forEach(pred => {
        if (pred.priority_score !== null && pred.priority_score !== undefined) {
            const val = pred.priority_score;
            if (val <= 20) scoreRanges['0-20%']++;
            else if (val <= 40) scoreRanges['21-40%']++;
            else if (val <= 60) scoreRanges['41-60%']++;
            else if (val <= 80) scoreRanges['61-80%']++;
            else scoreRanges['81-100%']++;
        }
    });
    
    const likelihoodCtx = document.getElementById('likelihoodChart').getContext('2d');
    if (likelihoodChart) likelihoodChart.destroy();
    
    likelihoodChart = new Chart(likelihoodCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(scoreRanges),
            datasets: [{
                label: 'Number of Animals',
                data: Object.values(scoreRanges),
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745', '#20c997']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Time to adoption distribution
    const timeRanges = {
        '0-30 days': 0,
        '31-60 days': 0,
        '61-90 days': 0,
        '91+ days': 0
    };
    
    data.forEach(pred => {
        if (pred.time_to_adoption_days !== null) {
            const val = pred.time_to_adoption_days;
            if (val <= 30) timeRanges['0-30 days']++;
            else if (val <= 60) timeRanges['31-60 days']++;
            else if (val <= 90) timeRanges['61-90 days']++;
            else timeRanges['91+ days']++;
        }
    });
    
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    if (timeChart) timeChart.destroy();
    
    timeChart = new Chart(timeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(timeRanges),
            datasets: [{
                label: 'Number of Animals',
                data: Object.values(timeRanges),
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Load feature importance
async function loadFeatureImportance() {
    try {
        const response = await fetch('/api/ml/feature-importance');
        if (!response.ok) {
            // Models not trained yet
            return;
        }
        const importance = await response.json();
        
        // Display adoption likelihood importance
        if (importance.adoption_likelihood) {
            const container = document.getElementById('likelihoodImportance');
            let html = '<div class="list-group">';
            const sorted = Object.entries(importance.adoption_likelihood)
                .sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([feature, value]) => {
                const percentage = (value * 100).toFixed(1);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge bg-primary">${percentage}%</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Display time to adoption importance
        if (importance.time_to_adoption) {
            const container = document.getElementById('timeImportance');
            let html = '<div class="list-group">';
            const sorted = Object.entries(importance.time_to_adoption)
                .sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([feature, value]) => {
                const percentage = (value * 100).toFixed(1);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge bg-primary">${percentage}%</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    } catch (error) {
        // Feature importance not available yet
        console.log('Feature importance not available:', error);
    }
}

// Load on page load
loadModelStatus();
loadPredictions();
loadFeatureImportance();
</script>
{% endblock %}
