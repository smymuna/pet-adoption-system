{% extends "base.html" %}

{% block title %}ML Predictions - Pet Adoption System{% endblock %}
{% block page_title %}Machine Learning Predictions{% endblock %}

{% block content %}
<!-- Explanation Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> What is Machine Learning Used For?</h5>
                <p class="mb-2">This system uses <strong>Machine Learning</strong> to help predict adoption outcomes for animals in the shelter:</p>
                <ul class="mb-2">
                    <li><strong>Adoption Likelihood Prediction:</strong> Uses a Random Forest Classifier to predict the probability (0-100%) that an animal will be adopted based on <strong>7 features</strong>: species, breed, age, gender, status, days in shelter, and medical history count.</li>
                    <li><strong>Time-to-Adoption Prediction:</strong> Uses a Random Forest Regressor to predict how many days it will take for an animal to be adopted using <strong>6 features</strong>: species, breed, age, gender, days in shelter, and medical history count.</li>
                </ul>
                <p class="mb-0"><strong>Features Used:</strong></p>
                <ul class="mb-0">
                    <li><strong>Species & Breed:</strong> Type and specific breed of the animal</li>
                    <li><strong>Age:</strong> Age in years</li>
                    <li><strong>Gender:</strong> Male or Female</li>
                    <li><strong>Status:</strong> Current status (Available, Adopted, Medical)</li>
                    <li><strong>Days in Shelter:</strong> How long the animal has been at the shelter (calculated from intake date)</li>
                    <li><strong>Medical History Count:</strong> Number of medical records/vet visits</li>
                </ul>
                <p class="mt-2 mb-0"><small class="text-muted">Models are trained on historical adoption data and improve as more data becomes available. Feature importance shows which factors matter most for predictions.</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Model Status & Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Model Status</h5>
            </div>
            <div class="card-body">
                <div id="modelStatus">
                    <p class="text-muted">Loading model status...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tools"></i> Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-2" onclick="trainModels()" style="width: 100%;">
            <i class="bi bi-gear"></i> Train Models
        </button>
                <button class="btn btn-success mb-2" onclick="loadPredictions()" style="width: 100%;">
            <i class="bi bi-arrow-clockwise"></i> Refresh Predictions
        </button>
                <small class="text-muted d-block">Train models first if they haven't been trained yet. Requires at least 10 animals for likelihood model and 5 adoptions for time-to-adoption model.</small>
            </div>
        </div>
    </div>
</div>

<!-- Predictions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Adoption Predictions for Available Animals</h5>
                <div>
                    <label class="form-label me-2">Sort by:</label>
                    <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="sortSelect" onchange="sortPredictions()">
                        <option value="likelihood-desc">Likelihood (High to Low)</option>
                        <option value="likelihood-asc">Likelihood (Low to High)</option>
                        <option value="time-asc">Time to Adoption (Shortest First)</option>
                        <option value="time-desc">Time to Adoption (Longest First)</option>
                        <option value="name">Name (A-Z)</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="predictionsContainer">
                    <p class="text-muted">Click "Refresh Predictions" to load predictions</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feature Importance Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Feature Importance - Adoption Likelihood</h5>
            </div>
            <div class="card-body">
                <div id="likelihoodImportance">
                    <p class="text-muted">Train models to see feature importance</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Feature Importance - Time to Adoption</h5>
            </div>
            <div class="card-body">
                <div id="timeImportance">
                    <p class="text-muted">Train models to see feature importance</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualization Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Adoption Likelihood Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="likelihoodChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Time to Adoption Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="timeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let predictionsData = [];
let likelihoodChart, timeChart;

// Load model status
async function loadModelStatus() {
    try {
        const response = await fetch('/api/ml/model-status');
        const status = await response.json();
        
        const container = document.getElementById('modelStatus');
        let html = '<div class="mb-2">';
        
        // Adoption Likelihood Model
        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
        html += '<span><strong>Adoption Likelihood Model:</strong></span>';
        if (status.adoption_likelihood.trained) {
            html += '<span class="badge bg-success">Trained</span>';
        } else {
            html += '<span class="badge bg-warning">Not Trained</span>';
        }
        html += '</div>';
        
        // Time to Adoption Model
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<span><strong>Time-to-Adoption Model:</strong></span>';
        if (status.time_to_adoption.trained) {
            html += '<span class="badge bg-success">Trained</span>';
        } else {
            html += '<span class="badge bg-warning">Not Trained</span>';
        }
        html += '</div>';
        
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        document.getElementById('modelStatus').innerHTML = '<p class="text-danger">Error loading model status</p>';
    }
}

// Train models
async function trainModels() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Training...';
    
    try {
        const response = await fetch('/api/ml/train', {
            method: 'POST'
        });
        const result = await response.json();
        
        if (response.ok) {
            let message = 'Models trained successfully!<br>';
            if (result.adoption_likelihood?.trained) {
                message += `✓ Adoption Likelihood Model: ${result.adoption_likelihood.accuracy}% accuracy<br>`;
            } else {
                message += `✗ Adoption Likelihood Model: ${result.adoption_likelihood?.message || 'Failed'}<br>`;
            }
            if (result.time_to_adoption?.trained) {
                message += `✓ Time-to-Adoption Model: R² = ${result.time_to_adoption.r2_score}<br>`;
            } else {
                message += `✗ Time-to-Adoption Model: ${result.time_to_adoption?.message || 'Failed'}<br>`;
            }
            showAlert(message, 'success');
            loadModelStatus();
            loadPredictions();
            loadFeatureImportance();
        } else {
            showAlert('Training failed: ' + (result.detail || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Error training models: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-gear"></i> Train Models';
    }
}

// Load predictions
async function loadPredictions() {
    const container = document.getElementById('predictionsContainer');
    container.innerHTML = '<p class="text-muted">Loading predictions...</p>';
    
    try {
        const response = await fetch('/api/ml/predictions');
        predictionsData = await response.json();
        
        if (predictionsData.length === 0) {
            container.innerHTML = '<p class="text-muted">No predictions available. Train models first or ensure there are available animals.</p>';
            return;
        }
        
        renderPredictionsTable(predictionsData);
        updateCharts(predictionsData);
    } catch (error) {
        container.innerHTML = '<p class="text-danger">Error loading predictions: ' + error.message + '</p>';
    }
}

// Render predictions table
function renderPredictionsTable(data) {
    const container = document.getElementById('predictionsContainer');
    
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    html += '<thead><tr>';
    html += '<th>Name</th><th>Species</th><th>Breed</th><th>Age</th><th>Gender</th>';
    html += '<th>Adoption Likelihood</th><th>Time to Adoption</th><th>Priority</th>';
    html += '</tr></thead><tbody>';
    
    data.forEach(pred => {
        const likelihood = pred.adoption_likelihood !== null ? pred.adoption_likelihood + '%' : 'N/A';
        const time = pred.time_to_adoption_days !== null ? pred.time_to_adoption_days + ' days' : 'N/A';
        
        // Priority badge color
        let priorityClass = 'bg-secondary';
        if (pred.priority === 'High') priorityClass = 'bg-danger';
        else if (pred.priority === 'Medium') priorityClass = 'bg-warning';
        else if (pred.priority === 'Low') priorityClass = 'bg-info';
        
        // Likelihood progress bar color
        let likelihoodClass = 'bg-danger';
        if (pred.adoption_likelihood >= 70) likelihoodClass = 'bg-success';
        else if (pred.adoption_likelihood >= 40) likelihoodClass = 'bg-warning';
        
        html += `<tr>
            <td><strong>${pred.name}</strong></td>
            <td>${pred.species}</td>
            <td>${pred.breed || 'N/A'}</td>
            <td>${pred.age} years</td>
            <td>${pred.gender}</td>
            <td>
                ${pred.adoption_likelihood !== null ? `
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${likelihoodClass}" role="progressbar" 
                             style="width: ${pred.adoption_likelihood}%" 
                             aria-valuenow="${pred.adoption_likelihood}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${likelihood}
                        </div>
                    </div>
                ` : 'N/A'}
            </td>
            <td>${time}</td>
            <td><span class="badge ${priorityClass}">${pred.priority}</span></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Sort predictions
function sortPredictions() {
    const sortValue = document.getElementById('sortSelect').value;
    let sorted = [...predictionsData];
    
    switch(sortValue) {
        case 'likelihood-desc':
            sorted.sort((a, b) => (b.adoption_likelihood || 0) - (a.adoption_likelihood || 0));
            break;
        case 'likelihood-asc':
            sorted.sort((a, b) => (a.adoption_likelihood || 0) - (b.adoption_likelihood || 0));
            break;
        case 'time-asc':
            sorted.sort((a, b) => (a.time_to_adoption_days || Infinity) - (b.time_to_adoption_days || Infinity));
            break;
        case 'time-desc':
            sorted.sort((a, b) => (b.time_to_adoption_days || -Infinity) - (a.time_to_adoption_days || -Infinity));
            break;
        case 'name':
            sorted.sort((a, b) => a.name.localeCompare(b.name));
            break;
    }
    
    renderPredictionsTable(sorted);
}

// Update charts
function updateCharts(data) {
    // Likelihood distribution
    const likelihoodRanges = {
        '0-20%': 0,
        '21-40%': 0,
        '41-60%': 0,
        '61-80%': 0,
        '81-100%': 0
    };
    
    data.forEach(pred => {
        if (pred.adoption_likelihood !== null) {
            const val = pred.adoption_likelihood;
            if (val <= 20) likelihoodRanges['0-20%']++;
            else if (val <= 40) likelihoodRanges['21-40%']++;
            else if (val <= 60) likelihoodRanges['41-60%']++;
            else if (val <= 80) likelihoodRanges['61-80%']++;
            else likelihoodRanges['81-100%']++;
        }
    });
    
    const likelihoodCtx = document.getElementById('likelihoodChart').getContext('2d');
    if (likelihoodChart) likelihoodChart.destroy();
    
    likelihoodChart = new Chart(likelihoodCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(likelihoodRanges),
            datasets: [{
                label: 'Number of Animals',
                data: Object.values(likelihoodRanges),
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745', '#20c997']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Time to adoption distribution
    const timeRanges = {
        '0-30 days': 0,
        '31-60 days': 0,
        '61-90 days': 0,
        '91+ days': 0
    };
    
    data.forEach(pred => {
        if (pred.time_to_adoption_days !== null) {
            const val = pred.time_to_adoption_days;
            if (val <= 30) timeRanges['0-30 days']++;
            else if (val <= 60) timeRanges['31-60 days']++;
            else if (val <= 90) timeRanges['61-90 days']++;
            else timeRanges['91+ days']++;
        }
    });
    
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    if (timeChart) timeChart.destroy();
    
    timeChart = new Chart(timeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(timeRanges),
            datasets: [{
                label: 'Number of Animals',
                data: Object.values(timeRanges),
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Load feature importance
async function loadFeatureImportance() {
    try {
        const response = await fetch('/api/ml/feature-importance');
        if (!response.ok) {
            // Models not trained yet
            return;
        }
        const importance = await response.json();
        
        // Display adoption likelihood importance
        if (importance.adoption_likelihood) {
            const container = document.getElementById('likelihoodImportance');
            let html = '<div class="list-group">';
            const sorted = Object.entries(importance.adoption_likelihood)
                .sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([feature, value]) => {
                const percentage = (value * 100).toFixed(1);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge bg-primary">${percentage}%</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Display time to adoption importance
        if (importance.time_to_adoption) {
            const container = document.getElementById('timeImportance');
            let html = '<div class="list-group">';
            const sorted = Object.entries(importance.time_to_adoption)
                .sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([feature, value]) => {
                const percentage = (value * 100).toFixed(1);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge bg-primary">${percentage}%</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    } catch (error) {
        // Feature importance not available yet
        console.log('Feature importance not available:', error);
    }
}

// Load on page load
loadModelStatus();
loadPredictions();
loadFeatureImportance();
</script>
{% endblock %}
